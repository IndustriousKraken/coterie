{% extends "layouts/base.html" %}

{% block title %}Member Management - Coterie Admin{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
<div class="px-4 py-6">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Member Management</h1>
            <p class="mt-1 text-sm text-gray-600">{{ total_members }} total members</p>
        </div>
        <a href="/portal/admin/members/new"
           class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">
            Add Member
        </a>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <form hx-get="/portal/admin/members"
              hx-target="#members-table-container"
              hx-push-url="true"
              class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[200px]">
                <label for="search" class="block text-sm font-medium text-gray-700">Search</label>
                <input type="text"
                       id="search"
                       name="q"
                       value="{{ search_query }}"
                       placeholder="Name, email, or username..."
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div>
                <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                <select id="status"
                        name="status"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">All Statuses</option>
                    <option value="Active" {% if status_filter == "Active" %}selected{% endif %}>Active</option>
                    <option value="Pending" {% if status_filter == "Pending" %}selected{% endif %}>Pending</option>
                    <option value="Expired" {% if status_filter == "Expired" %}selected{% endif %}>Expired</option>
                    <option value="Suspended" {% if status_filter == "Suspended" %}selected{% endif %}>Suspended</option>
                    <option value="Honorary" {% if status_filter == "Honorary" %}selected{% endif %}>Honorary</option>
                </select>
            </div>
            <div>
                <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                <select id="type"
                        name="type"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">All Types</option>
                    <option value="Regular" {% if type_filter == "Regular" %}selected{% endif %}>Regular</option>
                    <option value="Student" {% if type_filter == "Student" %}selected{% endif %}>Student</option>
                    <option value="Corporate" {% if type_filter == "Corporate" %}selected{% endif %}>Corporate</option>
                    <option value="Lifetime" {% if type_filter == "Lifetime" %}selected{% endif %}>Lifetime</option>
                </select>
            </div>
            <button type="submit"
                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm font-medium">
                Filter
            </button>
            {% if search_query.len() > 0 || status_filter.len() > 0 || type_filter.len() > 0 %}
            <a href="/portal/admin/members"
               class="px-4 py-2 text-gray-500 hover:text-gray-700 text-sm">
                Clear
            </a>
            {% endif %}
        </form>
    </div>

    <!-- Members Table -->
    <div id="members-table-container" class="bg-white rounded-lg shadow-sm overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Member
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Type
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Joined
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Dues Until
                    </th>
                    <th scope="col" class="relative px-6 py-3">
                        <span class="sr-only">Actions</span>
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for member in members %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-gray-600 font-medium text-sm">{{ member.initials }}</span>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ member.full_name }}</div>
                                <div class="text-sm text-gray-500">{{ member.email }}</div>
                                <div class="text-xs text-gray-400">@{{ member.username }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if member.status == "Active" %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                        {% else if member.status == "Pending" %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                        {% else if member.status == "Expired" %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Expired</span>
                        {% else if member.status == "Suspended" %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Suspended</span>
                        {% else if member.status == "Honorary" %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">Honorary</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ member.membership_type }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ member.joined_at }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if let Some(dues) = member.dues_paid_until.as_ref() %}
                            {{ dues }}
                        {% else %}
                            <span class="text-gray-400">â€”</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div x-data="{ open: false }" class="relative inline-block text-left">
                            <button @click="open = !open"
                                    type="button"
                                    class="text-gray-400 hover:text-gray-600">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                                </svg>
                            </button>
                            <div x-show="open"
                                 @click.away="open = false"
                                 x-transition
                                 class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1">
                                    <a href="/portal/admin/members/{{ member.id }}"
                                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        View Details
                                    </a>
                                    {% if member.status == "Pending" %}
                                    <button hx-post="/portal/admin/members/{{ member.id }}/activate"
                                            hx-target="closest tr"
                                            hx-swap="outerHTML"
                                            class="block w-full text-left px-4 py-2 text-sm text-green-700 hover:bg-gray-100">
                                        Activate
                                    </button>
                                    {% endif %}
                                    {% if member.status == "Active" %}
                                    <button hx-post="/portal/admin/members/{{ member.id }}/suspend"
                                            hx-target="closest tr"
                                            hx-swap="outerHTML"
                                            class="block w-full text-left px-4 py-2 text-sm text-yellow-700 hover:bg-gray-100">
                                        Suspend
                                    </button>
                                    {% endif %}
                                    {% if member.status == "Suspended" %}
                                    <button hx-post="/portal/admin/members/{{ member.id }}/activate"
                                            hx-target="closest tr"
                                            hx-swap="outerHTML"
                                            class="block w-full text-left px-4 py-2 text-sm text-green-700 hover:bg-gray-100">
                                        Reactivate
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                        No members found matching your criteria
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if total_pages > 1 %}
        <!-- Pagination -->
        <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    Showing <span class="font-medium">{{ (current_page - 1) * per_page + 1 }}</span>
                    to <span class="font-medium">{{ std::cmp::min(current_page * per_page, total_members) }}</span>
                    of <span class="font-medium">{{ total_members }}</span> members
                </div>
                <nav class="flex gap-1">
                    {% if current_page > 1 %}
                    <a href="?page={{ current_page - 1 }}{% if search_query.len() > 0 %}&q={{ search_query }}{% endif %}{% if status_filter.len() > 0 %}&status={{ status_filter }}{% endif %}{% if type_filter.len() > 0 %}&type={{ type_filter }}{% endif %}"
                       class="px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">
                        Previous
                    </a>
                    {% endif %}
                    {% if current_page < total_pages %}
                    <a href="?page={{ current_page + 1 }}{% if search_query.len() > 0 %}&q={{ search_query }}{% endif %}{% if status_filter.len() > 0 %}&status={{ status_filter }}{% endif %}{% if type_filter.len() > 0 %}&type={{ type_filter }}{% endif %}"
                       class="px-3 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">
                        Next
                    </a>
                    {% endif %}
                </nav>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
